#!/bin/bash

# Скрипт для скачивания видео с YouTube с использованием yt-dlp.

# --- Цвета и функции логирования ---
RED='\033[0;31m'
GREEN='\033[0;32m'
VERY_LIGHT_BLUE='\033[0;36m'
NC='\033[0m' # No Color

log() {
    echo -e "${VERY_LIGHT_BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ОШИБКА]${NC} $1" >&2
    exit 1
}

success() {
    echo -e "${GREEN}[УСПЕХ]${NC} $1"
}

# --- Конфигурация ---
VIDEO_DIR="$HOME/video"
COOKIES_FILE="$HOME/cookies.txt"
URL=""

# --- Разбор аргументов ---
if [[ $# -eq 0 ]]; then
    echo "Использование: $0 -u <YOUTUBE_URL>"
    echo "  -u, --url    URL видео на YouTube"
    exit 1
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--url)
            URL="$2"
            shift 2
            ;;
        *)
            error "Неизвестная опция: $1"
            ;;
    esac
done

if [[ -z "$URL" ]]; then
    error "URL не указан. Используйте -u или --url."
fi

# --- Проверки перед запуском ---
log "Проверка наличия yt-dlp..."
if ! command -v yt-dlp &> /dev/null; then
    error "Утилита 'yt-dlp' не найдена. Пожалуйста, установите ее."
fi
success "yt-dlp найден."

log "Проверка файла с cookies..."
if [[ ! -f "$COOKIES_FILE" ]]; then
    error "Файл cookies не найден по пути: $COOKIES_FILE"
fi
success "Файл cookies найден."

# --- Основная логика ---
log "Создание директории для видео, если она не существует..."
mkdir -p "$VIDEO_DIR"
success "Директория для видео: $VIDEO_DIR"

log "Запуск скачивания видео по URL: $URL"

# Шаблон для сохранения: ~/video/ИмяАвтора/НазваниеВидео.mp4
OUTPUT_TEMPLATE="$VIDEO_DIR/%(uploader)s/%(title)s.%(ext)s"

if yt-dlp -f b --cookies "$COOKIES_FILE" --recode-video mp4 -o "$OUTPUT_TEMPLATE" "$URL"; then
    success "Видео успешно скачано."
else
    error "yt-dlp не смог скачать видео."
fi
